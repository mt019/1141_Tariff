# 1141 Tariff Notes

Course notes + tooling (MkDocs site, Jupyter helpers, CI deploy).

## Local Dev

- Start docs: `docker compose up -d docs` → open `http://127.0.0.1:11413`
- Rebuild after config/plugin changes: `docker compose build docs`
- Stop services: `docker compose down`
- Logs (follow): `docker compose logs -f docs`

## SEO Setup (Sitemap + RSS + Meta)

SEO-friendly features are enabled via MkDocs + Material:

- Sitemap: generated by MkDocs core `sitemap` plugin
- RSS feed: generated by `mkdocs-rss-plugin`
- Page metadata: parsed from YAML Front Matter (`meta` extension)

What you need to configure:

1) Set canonical site URL in `mkdocs/mkdocs.yml`:
   - `site_url: https://<user>.github.io/<repo>/` (GitHub Pages)
   - Also set `site_description` and `site_author`

2) Add YAML Front Matter to important pages (title/description/date):

   Example page header:

  ```yaml
    ---
    title: 關稅估價（CVA）概要
    description: 本頁整理 WTO CVA 與關稅法估價條文的對應與適用順序
    date: 2025-09-08
    tags: [關稅估價, CVA, 關稅法]
    ---
  ```

   Notes:
   - `title` overrides the page title used in metadata
   - `description` appears in Open Graph / SEO snippets
   - `date` is used by the RSS plugin (`date_from_meta: 'date'`)
   - `tags` are optional; shown in RSS and can help organization

3) Build/run locally:
   - `docker compose build docs && docker compose up -d docs`
   - Check: `http://127.0.0.1:11413/sitemap.xml`, `http://127.0.0.1:11413/feed.xml`

Troubleshooting:
- If `/feed.xml` or `/sitemap.xml` returns 404:
  - Ensure `mkdocs/mkdocs.yml` has `plugins: [sitemap, rss]` and a valid `site_url`.
  - Make sure the image includes `mkdocs-rss-plugin` (this repo’s `mkdocs/Dockerfile` does). Rebuild with `docker compose build docs`.
  - The RSS plugin now falls back to Git commit dates (`use_git: true`). If your repo has no commits yet, add at least one commit so dates can be derived, or add `date:` in page front matter.

## Jupyter (One‑Click URL)

The compose file exposes Jupyter on `127.0.0.1:11414`. A helper script starts the
container and prints a ready‑to‑open URL. It works whether a token is enabled or not.

- Run:
  - `bash scripts/jupyter_url.sh`
- Output example:
  - `[ok] Jupyter URL: http://127.0.0.1:11414/lab`
  - If tokens are enabled, it prints the full token URL mapped to the host port.

One‑liner (no script):
- `docker compose up -d jupyter && echo "http://127.0.0.1:11414/lab"`

If you enable tokens (remove `--ServerApp.token=''` from `docker-compose.yml`), fetch the
full URL with token like this:
- `docker compose up -d jupyter && docker compose logs --no-color jupyter | sed -n 's@.*http://[^ ]*?token=[A-Za-z0-9._-]*@\\0@p' | tail -n1 | sed -E 's@:8888@:11414@'`

Notes:
- The repository currently disables token and password for local use:
  - `start-notebook.sh --ServerApp.token='' --ServerApp.password=''`
- If you change the bind port in `docker-compose.yml`, update the script env vars:
  - `JUPYTER_HOST=127.0.0.1 JUPYTER_PORT=11414 bash scripts/jupyter_url.sh`

## Notebook Fixers

- `notebooks/md-fix.ipynb`（或「筆記一鍵修正_條項數字與清單空行.ipynb」）
  - Converts `第…條` / `第…項` Chinese numerals to Arabic
  - Ensures a blank line before the first list item in Markdown
  - Supports recursive folder targets and prints a tree for debugging visibility

- CLI alternative:
  - `python3 fix_cn_ordinals.py -v mkdocs/My_Notes` (dry-run with `--dry-run`)
  - Wrapper for notes: `bash fix_cn_ordinals_all.sh`

Tip (Docker users): mount the whole repo for notebooks to see all files:
`jupyter` service → volumes: `- ./:/home/jovyan/work`

## Project Structure

```text
.
├─ docker-compose.yml           # Local services: docs (MkDocs), jupyter
├─ README.md
├─ scripts/
│  └─ jupyter_url.sh            # One‑click: start Jupyter and print URL
├─ fix_cn_ordinals.py           # CLI: convert 第…條/項 to Arabic across files
├─ fix_cn_ordinals_all.sh       # Wrapper to run the fixer over notes
├─ notebooks/
│  ├─ 筆記一鍵修正_條項數字與清單空行.ipynb  # One‑click notebook fixer
│  └─ (others…)                 # Your working notebooks
├─ mkdocs/
│  ├─ mkdocs.yml                # MkDocs config (Material theme, SEO, RSS)
│  ├─ Dockerfile                # Image with required MkDocs plugins
│  └─ My_Notes/                 # Site content (docs_dir)
│     ├─ index.md
│     ├─ assets/                # JS/CSS and helpers
│     └─ 01課程筆記/…          # Course notes (Markdown)
├─ _Material/                   # Course materials (PDFs etc.)
│  └─ 命令/                     # Local commands/notes (ignored in git)
└─ .github/
   └─ workflows/
      └─ deploy.yml             # Build + deploy to GitHub Pages
```

Notes
- MkDocs builds from `mkdocs/mkdocs.yml` with `docs_dir: My_Notes` (relative to `mkdocs/`).
- Sitemap and RSS are enabled; set a valid `site_url` in `mkdocs/mkdocs.yml`.
- The notebook fixer supports recursive targets and shows a directory tree to help debug mounts.

## CI Deploy (GitHub Pages)

- Workflow: `.github/workflows/deploy.yml`
  - Checks out full git history (for RSS dates)
  - Installs MkDocs + plugins and builds with `mkdocs/mkdocs.yml`
  - Deploys to Pages. Set repo Settings → Pages → Source = GitHub Actions

- After deploy (GitHub Pages URL):
  - `https://<user>.github.io/<repo>/sitemap.xml`
  - `https://<user>.github.io/<repo>/feed.xml`
