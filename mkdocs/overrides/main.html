{% extends "base.html" %}

{% block extrahead %}
  {{ super() }}
  {# Canonical URL，避免重複內容造成權重分散 #}
  <link rel="canonical" href="{{ (page and page.canonical_url) or config.site_url }}">
  {# RSS 訂閱（由 mkdocs-rss-plugin 產生 rss.xml） #}
  {% set site_url = config.site_url or '' %}
  {% if site_url and not site_url.endswith('/') %}{% set site_url = site_url ~ '/' %}{% endif %}
  <link rel="alternate" type="application/rss+xml" title="{{ config.site_name }} RSS" href="{{ site_url ~ 'rss.xml' }}">

  {# Google Search Console 驗證 #}
  {% if config.extra and config.extra.google_site_verification %}
    <meta name="google-site-verification" content="HgMTZnEFg_uS3jjPeDSxhbNBA6tsFU6jG7IkWxEW6P4" />
  {% endif %}
  {# 站點與頁面關鍵字合併（前者來自 mkdocs.yml: extra.keywords；後者來自頁面 front matter: keywords） #}
  {% set global_kw = config.extra.keywords or [] %}
  {% set page_kw = [] %}
  {% if page and page.meta and page.meta.keywords %}
    {% if page.meta.keywords is string %}
      {% set page_kw = [page.meta.keywords] %}
    {% else %}
      {% set page_kw = page.meta.keywords %}
    {% endif %}
  {% endif %}
  {# Jinja's `unique` can yield a generator; convert to list for length/join #}
  {% set all_kw = ((global_kw + page_kw) | unique | list) %}
  {% if all_kw and all_kw | length > 0 %}
    <meta name="keywords" content="{{ all_kw | join(', ') }}">
  {% endif %}

  {# 其他常見 SEO 標籤（使用現有站點/頁面資料） #}
  <meta name="author" content="{{ config.site_author }}">
  <meta name="description" content="{{ (page and page.meta and page.meta.description) or (page and page.description) or config.site_description }}">

  {# robots 可由頁面 front matter: robots 覆蓋；否則用全站預設 extra.robots_default #}
  {% set robots_value = (page and page.meta and page.meta.robots) or (config.extra and config.extra.robots_default) %}
  {% if robots_value %}
    <meta name="robots" content="{{ robots_value }}">
  {% endif %}

  <meta property="og:locale" content="zh_TW">
  <meta property="og:site_name" content="{{ config.site_name }}">
  <meta property="og:title" content="{{ (page and page.title) or config.site_name }}">
  <meta property="og:description" content="{{ (page and page.meta and page.meta.description) or (page and page.description) or config.site_description }}">
  <meta property="og:type" content="article">
  <meta property="og:url" content="{{ (page and page.canonical_url) or config.site_url }}">

  {# og:image / twitter:image：優先頁面自訂，其次全站 extra.og_image；相對路徑轉絕對 #}
  {% set og_img = (page and page.meta and (page.meta.og_image or page.meta.image)) or (config.extra and config.extra.og_image) %}
  {% if og_img %}
    {% if og_img.startswith('http://') or og_img.startswith('https://') %}
      {% set og_img_abs = og_img %}
    {% else %}
      {% set og_img_abs = site_url ~ og_img.lstrip('/') %}
    {% endif %}
    <meta property="og:image" content="{{ og_img_abs }}">
    <meta name="twitter:image" content="{{ og_img_abs }}">
  {% endif %}

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="{{ (page and page.title) or config.site_name }}">
  <meta name="twitter:description" content="{{ (page and page.meta and page.meta.description) or (page and page.description) or config.site_description }}">

  {# 發布 / 更新時間（盡力從 front matter 或 git 插件取得） #}
  {% set published = (page and page.meta and (page.meta.date or page.meta.published))
      or (page and (page.git_creation_date_localized and page.git_creation_date_localized.iso_datetime))
      or (page and page.meta and (page.meta.git_creation_date_localized and page.meta.git_creation_date_localized.iso_datetime)) %}
  {% set modified = (page and page.meta and (page.meta.updated))
      or (page and (page.git_revision_date_localized and page.git_revision_date_localized.iso_datetime))
      or (page and page.meta and (page.meta.git_revision_date_localized and page.meta.git_revision_date_localized.iso_datetime)) %}
  {% if published %}
    <meta property="article:published_time" content="{{ published }}">
  {% endif %}
  {% if modified %}
    <meta property="article:modified_time" content="{{ modified }}">
  {% endif %}
{% endblock %}
